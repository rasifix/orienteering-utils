name: Publish Package

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: https://registry.npmjs.org

      - name: Remove npm auth token to enable OIDC
        run: npm config delete //registry.npmjs.org/:_authToken

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Version bump
        run: |
          npm version patch -m "chore: bump version to %s [skip ci]"
      
      - name: Push commit and tags
        run: git push origin master --follow-tags

      - name: Validate Trusted Publisher claims
        run: |
          echo "Requesting OIDC token..."
          TOKEN=$(curl -sLS \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=npm" \
            | jq -r '.value')

          CLAIMS=$(echo "$TOKEN" | cut -d '.' -f2 | base64 -d | jq -r .)

          # Extract fields
          CLAIM_REPO=$(echo "$CLAIMS" | jq -r .repository)
          CLAIM_WORKFLOW_REF=$(echo "$CLAIMS" | jq -r .job_workflow_ref)
          CLAIM_BRANCH=$(echo "$CLAIMS" | jq -r .ref)
          CLAIM_ACTOR=$(echo "$CLAIMS" | jq -r .actor)

          echo "OIDC claims:"
          echo "$CLAIMS"

          # Desired values
          EXPECTED_REPO="rasifix/orienteering-utils"
          EXPECTED_WORKFLOW_PATH=".github/workflows/publish.yml"
          EXPECTED_BRANCH="refs/heads/master"
          EXPECTED_ACTOR="rasifix"

          echo "Validating repository..."
          if [[ "$CLAIM_REPO" != "$EXPECTED_REPO" ]]; then
            echo "❌ Repository mismatch: expected $EXPECTED_REPO, got $CLAIM_REPO"
            exit 1
          fi

          echo "Validating workflow file path..."
          if [[ "$CLAIM_WORKFLOW_REF" != "$EXPECTED_REPO/$EXPECTED_WORKFLOW_PATH@$EXPECTED_BRANCH" ]]; then
            echo "❌ Workflow file mismatch: expected $EXPECTED_WORKFLOW_PATH, got $CLAIM_WORKFLOW_REF"
            exit 1
          fi

          echo "Validating branch..."
          if [[ "$CLAIM_BRANCH" != "$EXPECTED_BRANCH" ]]; then
            echo "❌ Branch mismatch: expected $EXPECTED_BRANCH, got $CLAIM_BRANCH"
            exit 1
          fi

          echo "Validating actor..."
          if [[ "$CLAIM_ACTOR" != "$EXPECTED_ACTOR" ]]; then
            echo "❌ Actor mismatch: expected $EXPECTED_ACTOR, got $CLAIM_ACTOR"
            exit 1
          fi

          echo "✅ Trusted Publisher claims match. OIDC authentication should work."
      
      - name: Unset npm token to allow OIDC
        run: |
          echo "Removing NODE_AUTH_TOKEN and temp .npmrc"
          unset NODE_AUTH_TOKEN
          npm config delete //registry.npmjs.org/:_authToken

      - name: Publish to npm
        run: npm publish --access public --loglevel verbose 
